<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mon Aide de FranÃ§ais ğŸ‡«ğŸ‡·</title>
    
    <!-- PWA / iOS Optimized Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#4A6FA5">
    <meta name="apple-mobile-web-app-title" content="Aide FR">
    
    <!-- Emoji Icon for PWA -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ‡«ğŸ‡·</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 rx=%2220%22 fill=%22%234A6FA5%22/><text x=%2210%22 y=%2275%22 font-size=%2270%22>ğŸ‡«ğŸ‡·</text></svg>">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;600;800&display=swap" rel="stylesheet">
    
    <!-- Manifest for PWA Support -->
    <link rel="manifest" href="data:application/json,{'name':'Mon Aide de FranÃ§ais','short_name':'Aide FR','start_url':'.','display':'standalone','background_color':'#f8fbff','theme_color':'#4A6FA5','icons':[{'src':'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 rx=%2220%22 fill=%22%234A6FA5%22/><text x=%2210%22 y=%2275%22 font-size=%2270%22>ğŸ‡«ğŸ‡·</text></svg>','sizes':'192x192','type':'image/svg+xml'}]}">

    <style>
        :root { --primary: #4A6FA5; }
        body { 
            font-family: 'Lexend', sans-serif; 
            background-color: #f8fbff; 
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            overscroll-behavior: none;
        }
        * { -webkit-touch-callout: none; }
        .kid-card {
            border-radius: 32px;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 6px solid white;
            box-shadow: 0 10px 0 rgba(0,0,0,0.05);
            position: relative;
            overflow: hidden;
        }
        .kid-card:active {
            transform: scale(0.92) translateY(6px);
            box-shadow: 0 4px 0 rgba(0,0,0,0.05);
        }
        @keyframes bounce-subtle {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
        .speaking {
            animation: bounce-subtle 0.6s infinite;
            filter: brightness(1.05);
            border-color: #ffd166 !important;
        }
        .cat-school { background: #E0F2FE; border-color: #7DD3FC; color: #0369A1; }
        .cat-basics { background: #FEF3C7; border-color: #FCD34D; color: #92400E; }
        .cat-feelings { background: #FCE7F3; border-color: #F9A8D4; color: #9D174D; }
        .cat-homework { background: #DCFCE7; border-color: #86EFAC; color: #166534; }
        .cat-urgent { background: #FFF1F2; border-color: #FECDD3; color: #BE123C; }
        
        .phrase-0 { background-color: #FFADAD; border-color: #FF8B8B; } 
        .phrase-1 { background-color: #FFD6A5; border-color: #FFC47D; } 
        .phrase-2 { background-color: #FDFFB6; border-color: #F9FC85; } 
        .phrase-3 { background-color: #CAFFBF; border-color: #A7F396; } 
        .phrase-4 { background-color: #9BF6FF; border-color: #6CEEFB; } 
        .phrase-5 { background-color: #A0C4FF; border-color: #7EB0FF; } 
        .phrase-6 { background-color: #BDB2FF; border-color: #A391FF; } 
        .phrase-7 { background-color: #FFC6FF; border-color: #FFA3FF; } 

        .back-button, .action-circle {
            background: white;
            border-radius: 50px;
            box-shadow: 0 4px 0 #e2e8f0;
            transition: all 0.1s;
        }
        .back-button:active, .action-circle:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #e2e8f0;
        }
        textarea { border-radius: 20px; resize: none; font-size: 18px; border: 4px solid #e2e8f0; }
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="pb-24">
    <div id="offlineIndicator" class="hidden fixed top-0 w-full bg-red-100 text-red-700 p-2 text-center text-xs font-bold z-[100]">
        âš ï¸ Mode Hors-ligne (AI dÃ©sactivÃ©e)
    </div>

    <header class="p-6 text-center sticky top-0 bg-[#f8fbff]/90 backdrop-blur-md z-50">
        <div id="headerNav" class="flex justify-between items-center max-w-md mx-auto">
            <button id="backBtn" onclick="showView('categories')" class="hidden back-button px-5 py-2 font-black text-blue-600 flex items-center gap-2">
                <span class="text-xl">ğŸ </span>
            </button>
            <h1 class="text-2xl font-black flex-1 text-blue-900" onclick="location.reload()">
                <span class="text-blue-500">Maman,</span> <span class="text-red-500">Aide-moi!</span>
            </h1>
            <button onclick="shareApp()" class="action-circle w-12 h-12 flex items-center justify-center text-xl">ğŸ“¤</button>
        </div>
    </header>

    <main class="max-w-md mx-auto px-4">
        <!-- Dashboard / Categories -->
        <div id="categoriesView" class="grid grid-cols-2 gap-4">
            <div onclick="showView('homework')" class="col-span-2 kid-card cat-homework p-6 flex items-center justify-between cursor-pointer">
                <div class="flex items-center gap-4">
                    <span class="text-5xl">ğŸ“</span>
                    <div>
                        <h2 class="text-2xl font-black">Devoirs</h2>
                        <p class="text-xs opacity-80 font-bold uppercase tracking-widest">Homework List</p>
                    </div>
                </div>
                <span id="hwCount" class="bg-white/60 px-4 py-2 rounded-full text-xs font-black">0</span>
            </div>
            <div onclick="showView('school')" class="kid-card cat-school p-6 text-center cursor-pointer"><div class="text-4xl mb-2">ğŸ«</div><h2 class="font-black text-sm">School</h2></div>
            <div onclick="showView('basics')" class="kid-card cat-basics p-6 text-center cursor-pointer"><div class="text-4xl mb-2">âœ¨</div><h2 class="font-black text-sm">Yes/No</h2></div>
            <div onclick="showView('feelings')" class="kid-card cat-feelings p-6 text-center cursor-pointer"><div class="text-4xl mb-2">ğŸ˜Š</div><h2 class="font-black text-sm">Feelings</h2></div>
            <div onclick="showView('urgent')" class="kid-card cat-urgent p-6 text-center cursor-pointer"><div class="text-4xl mb-2">ğŸš¨</div><h2 class="font-black text-sm">Help!</h2></div>
            <div onclick="showView('recess')" class="kid-card bg-orange-100 border-orange-300 p-6 text-center cursor-pointer"><div class="text-4xl mb-2">ğŸƒ</div><h2 class="font-black text-sm text-orange-800">Recess</h2></div>
            <div onclick="showView('cafeteria')" class="kid-card bg-gray-100 border-gray-400 p-6 text-center cursor-pointer"><div class="text-4xl mb-2">ğŸ•</div><h2 class="font-black text-sm text-gray-800">Lunch</h2></div>
            <div onclick="showView('colors')" class="kid-card bg-pink-100 border-pink-300 p-6 text-center cursor-pointer"><div class="text-4xl mb-2">ğŸ¨</div><h2 class="font-black text-sm text-pink-800">Colors</h2></div>
            <div onclick="showView('numbers')" class="kid-card bg-purple-100 border-purple-300 p-6 text-center cursor-pointer"><div class="text-4xl mb-2">ğŸ”¢</div><h2 class="font-black text-sm text-purple-800">Numbers</h2></div>
            <div onclick="showView('supplies')" class="kid-card bg-emerald-100 border-emerald-300 p-6 text-center cursor-pointer"><div class="text-4xl mb-2">âœï¸</div><h2 class="font-black text-sm text-emerald-800">Tools</h2></div>
            <div onclick="showView('greetings')" class="kid-card bg-cyan-100 border-cyan-300 p-6 text-center cursor-pointer"><div class="text-4xl mb-2">ğŸ‘‹</div><h2 class="font-black text-sm text-cyan-800">Hello</h2></div>
            <div onclick="showView('questions')" class="kid-card bg-indigo-100 border-indigo-300 p-6 text-center cursor-pointer"><div class="text-4xl mb-2">â“</div><h2 class="font-black text-sm text-indigo-800">Ask</h2></div>
            <div onclick="showView('others')" class="kid-card bg-slate-200 border-slate-400 p-6 text-center cursor-pointer"><div class="text-4xl mb-2">ğŸŒŸ</div><h2 class="font-black text-sm text-slate-800">More</h2></div>
        </div>

        <div id="phrasesView" class="hidden space-y-6">
            <div id="homeworkControls" class="hidden mb-6 bg-white p-6 rounded-[40px] border-4 border-dashed border-green-300">
                <h3 class="font-black text-green-600 mb-3 flex items-center gap-2"><span>ğŸ‘©â€ğŸ«</span> Parent: Add homework words</h3>
                <textarea id="hwInput" class="w-full h-32 p-4 bg-green-50 outline-none font-bold text-green-800" placeholder="Ex: Chien | Dog"></textarea>
                <button id="saveHwBtn" onclick="saveHW()" class="w-full mt-4 bg-green-500 text-white font-black py-5 rounded-[25px] shadow-lg active:scale-95 transition-all text-xl">Save to Phone</button>
            </div>
            <div id="phraseList" class="space-y-6 pb-20"></div>
        </div>
    </main>

    <script>
        const apiKey = ""; 

        // --- SPEECH PRE-WARMING (CRITICAL FOR IOS SAFARI) ---
        let speechWarmed = false;
        function preWarmSpeech() {
            if (speechWarmed) return;
            const ut = new SpeechSynthesisUtterance("");
            ut.volume = 0;
            window.speechSynthesis.speak(ut);
            speechWarmed = true;
        }

        let hwPhrases = JSON.parse(localStorage.getItem('homeworkPhrases')) || [
            { fr: "Je m'appelle Sophie", en: "My name is Sophie" },
            { fr: "J'ai six ans", en: "I am six years old" }
        ];

        const datasets = {
            "basics": [
                { fr: "Oui", en: "Yes" }, { fr: "Non", en: "No" }, { fr: "Merci", en: "Thank you" }, 
                { fr: "De rien", en: "You're welcome" }, { fr: "S'il vous plaÃ®t", en: "Please" }, 
                { fr: "Pardon", en: "Sorry" }, { fr: "Excusez-moi", en: "Excuse me" },
                { fr: "Je comprends", en: "I understand" }, { fr: "Je ne comprends pas", en: "I don't understand" },
                { fr: "Je ne sais pas", en: "I don't know" }, { fr: "D'accord", en: "Okay" },
                { fr: "Bien sÃ»r", en: "Of course" }, { fr: "Peut-Ãªtre", en: "Maybe" },
                { fr: "Pas encore", en: "Not yet" }, { fr: "Maintenant", en: "Now" },
                { fr: "Plus tard", en: "Later" }, { fr: "Ici", en: "Here" },
                { fr: "LÃ -bas", en: "Over there" }, { fr: "Moi", en: "Me" }, { fr: "Toi", en: "You" }
            ],
            "school": [
                { fr: "Puis-je aller aux toilettes?", en: "Can I go to the bathroom?" },
                { fr: "Puis-je boire de l'eau?", en: "Can I drink some water?" },
                { fr: "J'ai fini!", en: "I'm finished!" },
                { fr: "Aide-moi, s'il vous plaÃ®t", en: "Help me, please" },
                { fr: "RÃ©pÃ©tez, s'il vous plaÃ®t", en: "Repeat, please" },
                { fr: "Asseyez-vous", en: "Sit down" },
                { fr: "Levez-vous", en: "Stand up" },
                { fr: "Ã‰coutez", en: "Listen" },
                { fr: "Regardez", en: "Look" },
                { fr: "Ouvrez le livre", en: "Open the book" },
                { fr: "Fermez le livre", en: "Close the book" },
                { fr: "Ã‰crivez", en: "Write" },
                { fr: "Lisez", en: "Read" },
                { fr: "Dessinez", en: "Draw" },
                { fr: "Chantez", en: "Sing" },
                { fr: "Silence, s'il vous plaÃ®t", en: "Silence, please" },
                { fr: "Rangez vos affaires", en: "Put your things away" },
                { fr: "Sortez un crayon", en: "Take out a pencil" },
                { fr: "Donnez-moi Ã§a", en: "Give me that" },
                { fr: "C'est mon pupitre", en: "It's my desk" }
            ],
            "feelings": [
                { fr: "Je suis contente", en: "I am happy" },
                { fr: "Je suis triste", en: "I am sad" },
                { fr: "Je suis fatiguÃ©e", en: "I am tired" },
                { fr: "Je suis malade", en: "I am sick" },
                { fr: "Je suis fÃ¢chÃ©e", en: "I am angry" },
                { fr: "J'ai peur", en: "I am scared" },
                { fr: "Je suis excitÃ©e", en: "I am excited" },
                { fr: "J'ai faim", en: "I am hungry" },
                { fr: "J'ai soif", en: "I am thirsty" },
                { fr: "J'ai froid", en: "I am cold" },
                { fr: "J'ai chaud", en: "I am hot" },
                { fr: "Je suis surprise", en: "I am surprised" },
                { fr: "Je suis fiÃ¨re", en: "I am proud" },
                { fr: "Je suis timide", en: "I am shy" },
                { fr: "C'est drÃ´le!", en: "It's funny!" },
                { fr: "Je m'ennuie", en: "I am bored" },
                { fr: "Je suis nerveuse", en: "I am nervous" },
                { fr: "Je suis calme", en: "I am calm" },
                { fr: "Je t'aime", en: "I love you" },
                { fr: "C'est super!", en: "It's great!" }
            ],
            "urgent": [
                { fr: "Aidez-moi!", en: "Help me!" },
                { fr: "ArrÃªte!", en: "Stop!" },
                { fr: "J'ai mal", en: "I am hurt" },
                { fr: "Je suis perdue", en: "I am lost" },
                { fr: "Je me sens mal", en: "I feel sick" },
                { fr: "OÃ¹ est Maman?", en: "Where is Mom?" },
                { fr: "J'ai besoin d'un pansement", en: "I need a bandage" },
                { fr: "Attention!", en: "Watch out!" },
                { fr: "Vite!", en: "Quickly!" },
                { fr: "Ne fais pas Ã§a", en: "Don't do that" },
                { fr: "Appelez le professeur", en: "Call the teacher" },
                { fr: "Je suis tombÃ©e", en: "I fell down" },
                { fr: "Ã‡a saigne", en: "It's bleeding" },
                { fr: "Laisse-moi tranquille", en: "Leave me alone" },
                { fr: "C'est Ã  moi!", en: "It's mine!" },
                { fr: "Au secours!", en: "Help!" },
                { fr: "Je ne trouve pas mon sac", en: "I can't find my bag" },
                { fr: "Je suis coincÃ©e", en: "I am stuck" },
                { fr: "J'ai soif", en: "I am thirsty" },
                { fr: "Je veux rentrer", en: "I want to go home" }
            ],
            "questions": [
                { fr: "Qu'est-ce que c'est?", en: "What is it?" },
                { fr: "Pourquoi?", en: "Why?" },
                { fr: "OÃ¹ est...?", en: "Where is...?" },
                { fr: "Qui est-ce?", en: "Who is it?" },
                { fr: "Quand est-ce qu'on mange?", en: "When do we eat?" },
                { fr: "Comment Ã§a va?", en: "How are you?" },
                { fr: "Quel Ã¢ge as-tu?", en: "How old are you?" },
                { fr: "Quelle heure est-il?", en: "What time is it?" },
                { fr: "Comment dit-on...?", en: "How do you say...?" },
                { fr: "C'est quoi Ã§a?", en: "What's that?" },
                { fr: "Puis-je jouer?", en: "Can I play?" },
                { fr: "Est-ce que je peux...?", en: "Am I allowed to...?" },
                { fr: "OÃ¹ sont les toilettes?", en: "Where is the bathroom?" },
                { fr: "As-tu un crayon?", en: "Do you have a pencil?" },
                { fr: "C'est fini?", en: "Is it finished?" },
                { fr: "Vrai ou faux?", en: "True or false?" },
                { fr: "Lequel?", en: "Which one?" },
                { fr: "Combien?", en: "How many?" },
                { fr: "Quoi encore?", en: "What else?" },
                { fr: "On y va?", en: "Shall we go?" }
            ],
            "recess": [
                { fr: "On joue ensemble?", en: "Shall we play together?" },
                { fr: "C'est mon tour", en: "It's my turn" },
                { fr: "Attrape!", en: "Catch!" },
                { fr: "C'est amusant!", en: "It's fun!" },
                { fr: "Cours!", en: "Run!" },
                { fr: "Saute!", en: "Jump!" },
                { fr: "Touche!", en: "Tag!" },
                { fr: "Cache-toi!", en: "Hide!" },
                { fr: "Je t'ai eu!", en: "I got you!" },
                { fr: "On joue au ballon?", en: "Shall we play ball?" },
                { fr: "C'est trichÃ©!", en: "That's cheating!" },
                { fr: "Encore une fois", en: "One more time" },
                { fr: "Regarde-moi!", en: "Look at me!" },
                { fr: "Plus vite!", en: "Faster!" },
                { fr: "ArrÃªte Ã§a", en: "Stop that" },
                { fr: "C'est Ã  ton tour", en: "It's your turn" },
                { fr: "Viens ici", en: "Come here" },
                { fr: "Attends-moi!", en: "Wait for me!" },
                { fr: "Tu es mon ami", en: "You are my friend" },
                { fr: "On fait une course?", en: "Shall we race?" }
            ],
            "cafeteria": [
                { fr: "J'ai faim", en: "I'm hungry" },
                { fr: "J'ai soif", en: "I'm thirsty" },
                { fr: "Ma boÃ®te Ã  lunch", en: "My lunchbox" },
                { fr: "C'est bon!", en: "It's good!" },
                { fr: "Je n'aime pas Ã§a", en: "I don't like this" },
                { fr: "Une pomme", en: "An apple" },
                { fr: "De l'eau, s'il vous plaÃ®t", en: "Water, please" },
                { fr: "Du jus", en: "Some juice" },
                { fr: "Du lait", en: "Some milk" },
                { fr: "Un sandwich", en: "A sandwich" },
                { fr: "Un biscuit", en: "A cookie" },
                { fr: "J'ai fini de manger", en: "I'm done eating" },
                { fr: "Est-ce que je peux avoir...?", en: "Can I have...?" },
                { fr: "Une serviette, s'il vous plaÃ®t", en: "A napkin, please" },
                { fr: "C'est chaud", en: "It's hot" },
                { fr: "C'est froid", en: "It's cold" },
                { fr: "Ouvre Ã§a, s'il vous plaÃ®t", en: "Open this, please" },
                { fr: "Merci pour le repas", en: "Thanks for the meal" },
                { fr: "Je peux m'asseoir ici?", en: "Can I sit here?" },
                { fr: "Passe-moi le sel", en: "Pass me the salt" }
            ],
            "colors": [
                { fr: "Rouge", en: "Red" }, { fr: "Bleu", en: "Blue" }, { fr: "Jaune", en: "Yellow" },
                { fr: "Vert", en: "Green" }, { fr: "Orange", en: "Orange" }, { fr: "Rose", en: "Pink" },
                { fr: "Violet", en: "Purple" }, { fr: "Noir", en: "Black" }, { fr: "Blanc", en: "White" },
                { fr: "Gris", en: "Grey" }, { fr: "Brun", en: "Brown" }, { fr: "Beige", en: "Beige" },
                { fr: "Or", en: "Gold" }, { fr: "Argent", en: "Silver" }, { fr: "Clair", en: "Light" },
                { fr: "FoncÃ©", en: "Dark" }, { fr: "Multicolore", en: "Multicolor" },
                { fr: "Bleu ciel", en: "Sky blue" }, { fr: "Vert lime", en: "Lime green" },
                { fr: "PrÃ©fÃ©rÃ©e", en: "Favorite" }
            ],
            "numbers": [
                { fr: "Un", en: "1" }, { fr: "Deux", en: "2" }, { fr: "Trois", en: "3" },
                { fr: "Quatre", en: "4" }, { fr: "Cinq", en: "5" }, { fr: "Six", en: "6" },
                { fr: "Sept", en: "7" }, { fr: "Huit", en: "8" }, { fr: "Neuf", en: "9" },
                { fr: "Dix", en: "10" }, { fr: "Onze", en: "11" }, { fr: "Douze", en: "12" },
                { fr: "Treize", en: "13" }, { fr: "Quatorze", en: "14" }, { fr: "Quinze", en: "15" },
                { fr: "Seize", en: "16" }, { fr: "Dix-sept", en: "17" }, { fr: "Dix-huit", en: "18" },
                { fr: "Dix-neuf", en: "19" }, { fr: "Vingt", en: "20" }
            ],
            "supplies": [
                { fr: "Un crayon", en: "A pencil" }, { fr: "Un stylo", en: "A pen" },
                { fr: "Une gomme", en: "An eraser" }, { fr: "Une rÃ¨gle", en: "A ruler" },
                { fr: "Un cahier", en: "A notebook" }, { fr: "Un livre", en: "A book" },
                { fr: "Des ciseaux", en: "Scissors" }, { fr: "De la colle", en: "Glue" },
                { fr: "Mon sac Ã  dos", en: "My backpack" }, { fr: "Une feuille", en: "A sheet of paper" },
                { fr: "Un marqueur", en: "A marker" }, { fr: "Des crayons de couleur", en: "Pencil crayons" },
                { fr: "Un taille-crayon", en: "A sharpener" }, { fr: "Une calculatrice", en: "A calculator" },
                { fr: "Mon pupitre", en: "My desk" }, { fr: "Ma chaise", en: "My chair" },
                { fr: "Le tableau", en: "The board" }, { fr: "Une affiche", en: "A poster" },
                { fr: "L'ordinateur", en: "The computer" }, { fr: "Une tablette", en: "A tablet" }
            ],
            "greetings": [
                { fr: "Bonjour", en: "Hello" }, { fr: "Salut", en: "Hi" },
                { fr: "Au revoir", en: "Goodbye" }, { fr: "Ã€ demain", en: "See you tomorrow" },
                { fr: "Ã€ plus tard", en: "See you later" }, { fr: "Bonne journÃ©e", en: "Have a good day" },
                { fr: "Bonne nuit", en: "Good night" }, { fr: "Comment vas-tu?", en: "How are you?" },
                { fr: "Ã‡a va bien", en: "I'm doing well" }, { fr: "EnchantÃ©e", en: "Nice to meet you" },
                { fr: "Bienvenue", en: "Welcome" }, { fr: "AllÃ´?", en: "Hello (phone)?" },
                { fr: "Ã€ tout Ã  l'heure", en: "See you in a bit" }, { fr: "Ã€ bientÃ´t", en: "See you soon" },
                { fr: "Coucou!", en: "Hey!" }, { fr: "Ã‡a va mal", en: "It's going poorly" },
                { fr: "Comme ci, comme Ã§a", en: "So-so" }, { fr: "Je m'appelle...", en: "My name is..." },
                { fr: "Ravi de te voir", en: "Glad to see you" }, { fr: "Passe un bon weekend", en: "Have a good weekend" }
            ],
            "others": [
                { fr: "Regarde!", en: "Look!" }, { fr: "Moi aussi", en: "Me too" },
                { fr: "C'est cool", en: "It's cool" }, { fr: "C'est gÃ©nial", en: "It's awesome" },
                { fr: "Beau travail", en: "Good job" }, { fr: "Fais attention", en: "Be careful" },
                { fr: "C'est difficile", en: "It's hard" }, { fr: "C'est facile", en: "It's easy" },
                { fr: "DÃ©pÃªche-toi", en: "Hurry up" }, { fr: "Attends", en: "Wait" },
                { fr: "Une seconde", en: "One second" }, { fr: "C'est prÃªt", en: "It's ready" },
                { fr: "Allons-y", en: "Let's go" }, { fr: "Mon ami", en: "My friend" },
                { fr: "J'aime Ã§a", en: "I like that" }, { fr: "Je n'aime pas Ã§a", en: "I don't like that" },
                { fr: "C'est nouveau", en: "It's new" }, { fr: "C'est vieux", en: "It's old" },
                { fr: "Il pleut", en: "It's raining" }, { fr: "Il fait soleil", en: "It's sunny" }
            ]
        };

        function showView(viewId) {
            preWarmSpeech(); 
            const catView = document.getElementById('categoriesView');
            const phrView = document.getElementById('phrasesView');
            const backBtn = document.getElementById('backBtn');
            const hwCtrl = document.getElementById('homeworkControls');

            if (viewId === 'categories') {
                catView.classList.remove('hidden');
                phrView.classList.add('hidden');
                backBtn.classList.add('hidden');
                updateHwCount();
            } else {
                catView.classList.add('hidden');
                phrView.classList.remove('hidden');
                backBtn.classList.remove('hidden');
                let list = viewId === 'homework' ? hwPhrases : datasets[viewId];
                renderPhrases(list, viewId);
                if (viewId === 'homework') {
                    hwCtrl.classList.remove('hidden');
                    document.getElementById('hwInput').value = hwPhrases.map(p => p.fr === p.en ? p.fr : `${p.fr} | ${p.en}`).join('\n');
                } else {
                    hwCtrl.classList.add('hidden');
                }
            }
            window.scrollTo(0, 0);
        }

        function renderPhrases(list, catId) {
            const container = document.getElementById('phraseList');
            container.innerHTML = list.map((p, i) => {
                const colorIdx = i % 8;
                return `
                <div id="p-${catId}-${i}" class="kid-card phrase-${colorIdx} p-6 flex flex-col gap-4 phrase-card">
                    <div onclick="speak('${p.fr.replace(/'/g, "\\'")}', 'fr-FR', 'p-${catId}-${i}')" class="flex items-center gap-5 cursor-pointer">
                        <div class="bg-white/90 w-16 h-16 rounded-2xl flex items-center justify-center text-3xl shadow-sm">ğŸ‡«ğŸ‡·</div>
                        <h3 class="text-2xl font-black text-slate-800 flex-1 leading-tight">${p.fr}</h3>
                    </div>
                    <div onclick="speak('${p.en.replace(/'/g, "\\'")}', 'en-US', 'p-${catId}-${i}')" class="flex items-center gap-5 cursor-pointer pt-4 border-t-4 border-black/5">
                        <div class="bg-white/60 w-16 h-16 rounded-2xl flex items-center justify-center text-3xl shadow-sm">ğŸ‡¬ğŸ‡§</div>
                        <h3 class="text-xl font-black text-slate-600 flex-1">${p.en}</h3>
                    </div>
                </div>
            `}).join('');
        }

        function speak(text, lang, id) {
            if (!text) return;
            preWarmSpeech();
            window.speechSynthesis.cancel();
            
            document.querySelectorAll('.phrase-card').forEach(c => c.classList.remove('speaking'));
            const card = document.getElementById(id);
            if (card) card.classList.add('speaking');
            
            const ut = new SpeechSynthesisUtterance(text);
            ut.lang = lang;
            ut.rate = lang === 'fr-FR' ? 0.75 : 0.9;
            ut.onend = () => card && card.classList.remove('speaking');
            window.speechSynthesis.speak(ut);
        }

        async function saveHW() {
            const val = document.getElementById('hwInput').value;
            const btn = document.getElementById('saveHwBtn');
            const lines = val.split('\n').map(l => l.trim()).filter(l => l !== "");
            
            btn.disabled = true;
            btn.innerHTML = `<div class="loader mx-auto"></div>`;

            let newList = [];
            for (let line of lines) {
                if (line.includes('|')) {
                    const parts = line.split('|');
                    newList.push({ fr: parts[0].trim(), en: parts[1].trim() });
                } else if (apiKey && navigator.onLine) {
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                contents: [{ parts: [{ text: `Translate French to simple English for a child: "${line}"` }] }] 
                            })
                        });
                        const data = await response.json();
                        newList.push({ fr: line, en: data.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || line });
                    } catch (e) { newList.push({ fr: line, en: line }); }
                } else {
                    newList.push({ fr: line, en: line });
                }
            }

            hwPhrases = newList;
            localStorage.setItem('homeworkPhrases', JSON.stringify(hwPhrases));
            renderPhrases(hwPhrases, 'homework');
            btn.disabled = false;
            btn.innerHTML = "SauvegardÃ© ! âœ¨";
            setTimeout(() => btn.innerHTML = "Save to Phone", 2000);
        }

        function shareApp() {
            if (navigator.share) navigator.share({ title: 'Aide FranÃ§ais', url: window.location.href });
            else prompt("Lien:", window.location.href);
        }

        function updateHwCount() {
            const el = document.getElementById('hwCount');
            if (el) el.innerText = hwPhrases.length;
        }

        // --- OFFLINE DETECTION ---
        window.addEventListener('online',  () => document.getElementById('offlineIndicator').classList.add('hidden'));
        window.addEventListener('offline', () => document.getElementById('offlineIndicator').classList.remove('hidden'));
        
        // --- SERVICE WORKER REGISTRATION (IMPROVED) ---
        if ('serviceWorker' in navigator && window.location.protocol.startsWith('http')) {
            try {
                const swCode = `
                    const CACHE_NAME = 'aide-fr-v1';
                    self.addEventListener('install', (event) => {
                        event.waitUntil(caches.open(CACHE_NAME).then((cache) => cache.addAll(['./'])));
                    });
                    self.addEventListener('fetch', (event) => {
                        event.respondWith(caches.match(event.request).then((res) => res || fetch(event.request)));
                    });
                `;
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                navigator.serviceWorker.register(swUrl, { scope: './' })
                    .catch(err => console.log('SW registration skipped:', err.message));
            } catch (e) {
                console.warn("Service worker setup failed:", e);
            }
        }

        updateHwCount();
    </script>
</body>
</html>